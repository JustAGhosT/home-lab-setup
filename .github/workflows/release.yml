name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., v1.0.1)"
        required: true
        type: string

jobs:
  validate:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get version
        id: get-version
        run: |
          if ("${{ github.event_name }}" -eq "push") {
            $version = "${{ github.ref_name }}"
          } else {
            $version = "${{ github.event.inputs.version }}"
          }

          if (-not $version.StartsWith("v")) {
            $version = "v$version"
          }

          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
        shell: pwsh

      - name: Validate version format
        run: |
          $version = "${{ steps.get-version.outputs.version }}"
          if ($version -notmatch '^v\d+\.\d+\.\d+(-\w+)?$') {
            Write-Error "Invalid version format: $version. Expected format: v1.0.0 or v1.0.0-beta"
            exit 1
          }
          Write-Host "Version format is valid: $version"
        shell: pwsh

      - name: Install required modules
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -SkipPublisherCheck
          Install-Module -Name PowerShell-Yaml -Force -SkipPublisherCheck

      - name: Run tests
        shell: pwsh
        run: |
          cd tests
          ./Run-HomeLab-Tests.ps1 -TestType All
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Tests failed. Cannot proceed with release."
            exit 1
          }

  build:
    needs: validate
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Update module version
        run: |
          $version = "${{ needs.validate.outputs.version }}"
          $versionNumber = $version.TrimStart('v')

          # Update HomeLab.psd1
          $manifestPath = "src/HomeLab/HomeLab/HomeLab.psd1"
          $content = Get-Content $manifestPath -Raw
          $content = $content -replace "ModuleVersion\s*=\s*'[^']*'", "ModuleVersion = '$versionNumber'"
          $content = $content -replace "ReleaseNotes\s*=\s*'[^']*'", "ReleaseNotes = '$version - See CHANGELOG.md for details'"
          Set-Content -Path $manifestPath -Value $content

          Write-Host "Updated module version to $versionNumber"
        shell: pwsh

      - name: Create release package
        run: |
          $version = "${{ needs.validate.outputs.version }}"

          # Create release directory
          $releaseDir = "release"
          New-Item -ItemType Directory -Path $releaseDir -Force

          # Copy essential files
          Copy-Item -Path "src/HomeLab" -Destination "$releaseDir/src/HomeLab" -Recurse
          Copy-Item -Path "functions" -Destination "$releaseDir/functions" -Recurse
          Copy-Item -Path "docs" -Destination "$releaseDir/docs" -Recurse
          Copy-Item -Path "tests" -Destination "$releaseDir/tests" -Recurse
          Copy-Item -Path "README.md" -Destination "$releaseDir/"
          Copy-Item -Path "LICENSE" -Destination "$releaseDir/"
          Copy-Item -Path "CHANGELOG.md" -Destination "$releaseDir/"
          Copy-Item -Path "CONTRIBUTING.md" -Destination "$releaseDir/"
          Copy-Item -Path "SECURITY.md" -Destination "$releaseDir/"

          # Create ZIP archive
          $archiveName = "HomeLab-$version.zip"
          Compress-Archive -Path "$releaseDir/*" -DestinationPath $archiveName

          Write-Host "Created release package: $archiveName"
        shell: pwsh

      - name: Upload release artifacts
        uses: actions/upload-artifact@v5
        with:
          name: release-package
          path: HomeLab-*.zip

  build-tauri-installer:
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            bundle_ext: ".msi,.exe"
          - platform: macos-latest
            target: x86_64-apple-darwin
            bundle_ext: ".dmg,.app.tar.gz"
          - platform: macos-latest
            target: aarch64-apple-darwin
            bundle_ext: ".dmg,.app.tar.gz"
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            bundle_ext: ".deb,.AppImage,.AppImage.tar.gz"
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install Rust stable
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        working-directory: app
        run: pnpm install

      - name: Update Tauri version
        working-directory: app/src-tauri
        shell: bash
        run: |
          version="${{ needs.validate.outputs.version }}"
          version_number="${version#v}"

          # Update version in tauri.conf.json
          if command -v jq &> /dev/null; then
            jq --arg v "$version_number" '.version = $v' tauri.conf.json > tmp.json && mv tmp.json tauri.conf.json
            echo "Updated tauri.conf.json version to $version_number using jq"
          else
            # Fallback for Windows without jq - use PowerShell
            if command -v pwsh &> /dev/null; then
              pwsh -Command "(Get-Content tauri.conf.json -Raw) -replace '\"version\": \"[^\"]*\"', '\"version\": \"$version_number\"' | Set-Content tauri.conf.json"
              echo "Updated tauri.conf.json version to $version_number using PowerShell"
            else
              sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$version_number\"/" tauri.conf.json
              echo "Updated tauri.conf.json version to $version_number using sed"
            fi
          fi

          # Update version in Cargo.toml
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^version = \"[^\"]*\"/version = \"$version_number\"/" Cargo.toml
          else
            sed -i "s/^version = \"[^\"]*\"/version = \"$version_number\"/" Cargo.toml
          fi
          echo "Updated Cargo.toml version to $version_number"

          # Verify updates
          echo "Verifying version updates..."
          grep -E '"version":|^version = ' tauri.conf.json Cargo.toml || true

      - name: Build Tauri app with updater artifacts
        working-directory: app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: pnpm tauri build --target ${{ matrix.target }}

      - name: Upload installer artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v5
        with:
          name: tauri-installer-windows
          path: |
            app/src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
            app/src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi.sig
            app/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            app/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe.sig

      - name: Upload installer artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@v5
        with:
          name: tauri-installer-macos-${{ matrix.target }}
          path: |
            app/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            app/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            app/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig

      - name: Upload installer artifacts (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        uses: actions/upload-artifact@v5
        with:
          name: tauri-installer-linux
          path: |
            app/src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            app/src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
            app/src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage.tar.gz
            app/src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage.tar.gz.sig

  release:
    needs: [validate, build, build-tauri-installer]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download PowerShell release artifacts
        uses: actions/download-artifact@v7
        with:
          name: release-package
          path: ./release-assets

      - name: Download Windows installer
        uses: actions/download-artifact@v7
        with:
          name: tauri-installer-windows
          path: ./release-assets
        continue-on-error: true

      - name: Download macOS x64 installer
        uses: actions/download-artifact@v7
        with:
          name: tauri-installer-macos-x86_64-apple-darwin
          path: ./release-assets
        continue-on-error: true

      - name: Download macOS ARM installer
        uses: actions/download-artifact@v7
        with:
          name: tauri-installer-macos-aarch64-apple-darwin
          path: ./release-assets
        continue-on-error: true

      - name: Download Linux installer
        uses: actions/download-artifact@v7
        with:
          name: tauri-installer-linux
          path: ./release-assets
        continue-on-error: true

      - name: Generate updater manifest (latest.json)
        run: |
          version="${{ needs.validate.outputs.version }}"
          version_number="${version#v}"
          pub_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          repo_url="https://github.com/${{ github.repository }}"

          # Extract changelog for release notes - support multiple formats
          notes=""
          if [ -f "CHANGELOG.md" ]; then
            # Try format: ## [version] or ## version
            notes=$(awk "/^## \\[?${version_number}\\]?/,/^## \\[?[0-9]/" CHANGELOG.md | tail -n +2 | head -n -1 | head -20)
            if [ -z "$notes" ]; then
              # Try format: # version or ## v1.0.0
              notes=$(awk "/^##? v?${version_number}/,/^##? v?[0-9]/" CHANGELOG.md | tail -n +2 | head -n -1 | head -20)
            fi
          fi

          if [ -z "$notes" ]; then
            notes="Release $version - See CHANGELOG.md for full details"
          fi

          # Escape the notes for JSON
          notes_json=$(echo "$notes" | jq -Rs .)

          # Generate the updater manifest with empty signatures initially
          cat > ./release-assets/latest.json << EOF
          {
            "version": "$version_number",
            "notes": $notes_json,
            "pub_date": "$pub_date",
            "platforms": {
              "windows-x86_64": {
                "signature": "",
                "url": "${repo_url}/releases/download/${version}/HomeLab_${version_number}_x64-setup.exe"
              },
              "darwin-x86_64": {
                "signature": "",
                "url": "${repo_url}/releases/download/${version}/HomeLab_${version_number}_x64.app.tar.gz"
              },
              "darwin-aarch64": {
                "signature": "",
                "url": "${repo_url}/releases/download/${version}/HomeLab_${version_number}_aarch64.app.tar.gz"
              },
              "linux-x86_64": {
                "signature": "",
                "url": "${repo_url}/releases/download/${version}/HomeLab_${version_number}_amd64.AppImage.tar.gz"
              }
            }
          }
          EOF

          # Track which signatures were found
          sig_count=0
          missing_sigs=""

          # Update signatures if signature files exist
          for sig_file in ./release-assets/*.sig; do
            if [ -f "$sig_file" ]; then
              sig_content=$(cat "$sig_file")
              base_name=$(basename "$sig_file" .sig)

              # Update the appropriate platform signature in latest.json
              if [[ "$base_name" == *"x64-setup.exe"* ]] || [[ "$base_name" == *".msi"* ]]; then
                jq --arg sig "$sig_content" '.platforms["windows-x86_64"].signature = $sig' ./release-assets/latest.json > tmp.json && mv tmp.json ./release-assets/latest.json
                sig_count=$((sig_count + 1))
                echo "âœ… Found Windows signature"
              elif [[ "$base_name" == *"x64.app.tar.gz"* ]]; then
                jq --arg sig "$sig_content" '.platforms["darwin-x86_64"].signature = $sig' ./release-assets/latest.json > tmp.json && mv tmp.json ./release-assets/latest.json
                sig_count=$((sig_count + 1))
                echo "âœ… Found macOS x64 signature"
              elif [[ "$base_name" == *"aarch64.app.tar.gz"* ]]; then
                jq --arg sig "$sig_content" '.platforms["darwin-aarch64"].signature = $sig' ./release-assets/latest.json > tmp.json && mv tmp.json ./release-assets/latest.json
                sig_count=$((sig_count + 1))
                echo "âœ… Found macOS ARM signature"
              elif [[ "$base_name" == *"amd64.AppImage.tar.gz"* ]] || [[ "$base_name" == *"AppImage"* ]]; then
                jq --arg sig "$sig_content" '.platforms["linux-x86_64"].signature = $sig' ./release-assets/latest.json > tmp.json && mv tmp.json ./release-assets/latest.json
                sig_count=$((sig_count + 1))
                echo "âœ… Found Linux signature"
              fi
            fi
          done

          # Check for missing signatures and warn
          echo ""
          echo "=== Signature Status ==="
          if [ $sig_count -eq 0 ]; then
            echo "âš ï¸ WARNING: No signatures found. Updates will not be cryptographically verified."
            echo "âš ï¸ To enable signed updates, configure TAURI_SIGNING_PRIVATE_KEY and TAURI_SIGNING_PRIVATE_KEY_PASSWORD secrets."
          elif [ $sig_count -lt 4 ]; then
            echo "âš ï¸ WARNING: Only $sig_count of 4 platform signatures found."
            echo "âš ï¸ Some platforms may not receive signed updates."
          else
            echo "âœ… All platform signatures found."
          fi

          echo ""
          echo "Generated latest.json:"
          cat ./release-assets/latest.json

      - name: Extract changelog for version
        id: changelog
        run: |
          version="${{ needs.validate.outputs.version }}"

          # Extract changelog section for this version
          if [ -f "CHANGELOG.md" ]; then
            # Get content between version headers
            changelog=$(sed -n "/## \[${version#v}\]/,/## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)
            if [ -z "$changelog" ]; then
              changelog="Release $version - See CHANGELOG.md for full details"
            fi
          else
            changelog="Release $version"
          fi

          # Save changelog to file for GitHub release
          echo "$changelog" > release-notes.md
          echo "Changelog extracted for $version"

      - name: List release assets
        run: |
          echo "Release assets:"
          find ./release-assets -type f | head -50

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body_path: release-notes.md
          files: |
            ./release-assets/*
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-powershell-gallery:
    needs: [validate, build, release]
    runs-on: windows-latest
    if: ${{ !contains(needs.validate.outputs.version, '-') }} # Only for stable releases
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download release artifacts
        uses: actions/download-artifact@v7
        with:
          name: release-package

      - name: Extract and prepare module
        run: |
          $archiveName = Get-ChildItem -Name "HomeLab-*.zip"
          Expand-Archive -Path $archiveName -DestinationPath "extracted"

          # Verify module structure
          if (-not (Test-Path "extracted/src/HomeLab/HomeLab/HomeLab.psd1")) {
            Write-Error "Module manifest not found in expected location"
            exit 1
          }

          Write-Host "Module prepared for PowerShell Gallery"
        shell: pwsh

      - name: Publish to PowerShell Gallery
        run: |
          # Note: This would require a PowerShell Gallery API key
          # For now, this is a placeholder for future implementation
          Write-Host "PowerShell Gallery publishing would happen here"
          Write-Host "Requires POWERSHELL_GALLERY_API_KEY secret to be configured"
        shell: pwsh
        # Uncomment when ready to publish:
        # env:
        #   POWERSHELL_GALLERY_API_KEY: ${{ secrets.POWERSHELL_GALLERY_API_KEY }}

  notify:
    needs: [validate, build, build-tauri-installer, release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Release Summary
        run: |
          echo "# ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.release.result }}" = "success" ]; then
            echo "âœ… Release created successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ Release package available in GitHub Releases" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“¥ Desktop App Installers" >> $GITHUB_STEP_SUMMARY
            echo "- Windows: MSI and NSIS installers" >> $GITHUB_STEP_SUMMARY
            echo "- macOS: DMG installers (x64 and ARM)" >> $GITHUB_STEP_SUMMARY
            echo "- Linux: DEB and AppImage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ”„ Auto-Update" >> $GITHUB_STEP_SUMMARY
            echo "The \`latest.json\` manifest has been published for automatic updates." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Release failed" >> $GITHUB_STEP_SUMMARY
          fi
